import re
import datetime
import csv
import sys 

def main(args):
    source, destination = parse_args(args)
    lines = list()

    with open(source, 'r') as reader:
        # Read and print the entire file line by line
        line = reader.readline()
        while line != '':
            if not re.match(r"^\d+", line.strip()):
                line = reader.readline()
                continue
            
            # fixing date            
            orig_date, processed_date = get_original_date(line)
            line = line.replace(orig_date, processed_date)
            # so states / cities do not have spaces in between
            line = re.sub(r"(\w) (\w)", "\\1_\\2", line.strip())
            # replacing dates
            line = re.sub("(\d+/\d+/\d+)", "\\1", line.strip())
            # replace space with commas
            line = re.sub("\s+", ",", line.strip())
            # adding the original date
            line = line + "," + orig_date
            # replacing NAs
            line = re.sub(r",NA,", ",,", line.strip())
            # bring back spaces instead of underscore
            line = line.replace("_", " ")
            # splitting...
            line = list(line.split(","))
            
            # recovered cases...
            if '*' in line[1]:
                line[1] = line[1].replace("*", "")
                line.append("*")
            else:
                line.append("")

            lines.append(line)

            line = reader.readline()

    with open(destination, 'w', newline='') as file:
        writer = csv.writer(file)
        writer.writerows(lines)

def parse_args(argv):
    if len(argv) < 2:
        print('usage: test.py <source> <destination>')
        exit()

    # TODO: improve & error handling

    return argv[0], argv[1]

# replacing excel dates
# see: https://stackoverflow.com/questions/14271791/converting-date-formats-python-unusual-date-formats-extract-ymd
def get_original_date(line):
    match = re.search(r'(\d{5})\s+', line)
    if not match:
        return "", ""
    
    m = match.group().replace(" ", "").replace(",","")
    delta = datetime.timedelta(int(m)-2)
    date = datetime.date(1900, 1, 1) + delta
    date = str(date.strftime("%d/%m/%Y"))
    
    return str(m), date  

if __name__ == "__main__":
    main(sys.argv[1:])